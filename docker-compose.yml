services:
  # --- Service 1 : L'API Flask ---
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: pixel-api
    env_file: .env
    environment:
      - FLASK_ENV=production
    volumes:
      - ${IMAGE_PATH}:/app/images:ro      # Les images restent lues depuis Windows
      - shared_static:/app/static
    networks:
      - frontend-net
      - backend-net
    restart: unless-stopped

  # --- Service 2 : Le Worker Batch ---
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: pixel-worker
    volumes:
      - ${IMAGE_PATH}:/app/images:ro
      - shared_static:/app/static         # Partage total avec l'API
    networks:
      - backend-net
    restart: "no"

  # --- Service 3 : Le Reverse Proxy Nginx ---
  proxy:
    image: nginx:1.25-alpine
    container_name: pixel-proxy
    ports:
      - "${PROXY_PORT:-8081}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - shared_static:/app/static:ro
    networks:
      - frontend-net
    depends_on:
      api:
        condition: service_healthy

networks:
  frontend-net:
    driver: bridge
  backend-net:
    driver: bridge

volumes:
  shared_static: # Déclaration du volume nommé